<%- include('layout', { title: 'Panel de Administración' }) %>

    <div class="shell">
        <table class="tabla">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Asignación</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <% users.forEach(u=> { %>
                    <tr>
                        <td>
                            <%= u.nombre %>
                        </td>
                        <td>
                            <%= u.email %>
                        </td>
                        <td>
                            <span class="badge role-<%= u.role %>">
                                <%= u.role %>
                            </span>
                        </td>
                        <td>
                            <% if (u.role==='profesor' ) { %>
                                <div class="assignment-info">
                                    <% if (u.materia_nombre) { %>
                                        <span class="current-assignment">
                                            <strong>
                                                <%= u.materia_nombre %>
                                            </strong>
                                            <% if (u.materia_ano) { %> (<%= u.materia_ano %>) <% } %>
                                        </span>
                                        <% } else { %>
                                            <span class="text-muted">Sin asignar</span>
                                            <% } %>
                                                <form action="/admin/users/<%= u.id %>/assign-materia" method="POST"
                                                    class="assign-form">
                                                    <select name="materiaId" onchange="this.form.submit()"
                                                        class="select-xs">
                                                        <option value="" <%=!u.materiaId ? 'selected' : '' %>>--
                                                            Seleccionar --</option>
                                                        <% materias.forEach(m=> { %>
                                                            <option value="<%= m.id %>" <%=u.materiaId===m.id
                                                                ? 'selected' : '' %>>
                                                                <%= m.nombre %>
                                                                    <%= m.ano ? '(' + m.ano + ')' : '' %>
                                                            </option>
                                                            <% }); %>
                                                    </select>
                                                </form>
                                </div>
                                <% } else if (u.role==='alumno' ) { %>
                                    <div class="assignment-info">
                                        <% if (u.curso_nombre) { %>
                                            <span class="current-assignment"><strong>
                                                    <%= u.curso_nombre %>
                                                </strong></span>
                                            <% } else { %>
                                                <span class="text-muted">Sin año</span>
                                                <% } %>
                                                    <form action="/admin/users/<%= u.id %>/assign-curso" method="POST"
                                                        class="assign-form">
                                                        <select name="cursoId" onchange="this.form.submit()"
                                                            class="select-xs">
                                                            <option value="" <%=!u.curso_nombre ? 'selected' : '' %>>--
                                                                Año --</option>
                                                            <% ['1°', '2°' , '3°' , '4°' , '5°' , '6°' ].forEach(ano=> {
                                                                %>
                                                                <option value="<%= ano %>" <%=u.curso_nombre===ano
                                                                    ? 'selected' : '' %>>
                                                                    <%= ano %>
                                                                </option>
                                                                <% }); %>
                                                        </select>
                                                    </form>
                                    </div>
                                    <% } else { %>
                                        <span class="text-muted">-</span>
                                        <% } %>
                        </td>
                        <td>
                            <% if (u.role==='profesor' ) { %>
                                <% if (u.validated) { %>
                                    <span class="badge badge-validated">✓ Validado</span>
                                    <% } else { %>
                                        <span class="badge badge-pending">⏳ Pendiente</span>
                                        <% } %>
                                            <% } else { %>
                                                <span class="text-muted">-</span>
                                                <% } %>
                        </td>
                        <td>
                            <% if (u.email !==user.email) { %>
                                <div class="actions">
                                    <% if (u.role==='profesor' && !u.validated) { %>
                                        <form action="/admin/users/<%= u.id %>/validate" method="POST"
                                            style="display:inline; margin-right: 5px;">
                                            <button type="submit" class="btn btn-success-sm">Validar</button>
                                        </form>
                                        <% } %>
                                            <form action="/admin/users/<%= u.id %>/role" method="POST"
                                                style="display:inline; margin-right: 5px;">
                                                <select name="role" onchange="this.form.submit()" class="select-sm">
                                                    <option value="" disabled selected>Cambiar Rol</option>
                                                    <option value="alumno">Alumno</option>
                                                    <option value="profesor">Profesor</option>
                                                    <option value="admin">Admin</option>
                                                </select>
                                            </form>
                                            <form action="/admin/users/<%= u.id %>/delete" method="POST"
                                                style="display:inline;"
                                                onsubmit="return confirm('¿Eliminar usuario?');">
                                                <button type="submit" class="btn btn-danger-sm">Eliminar</button>
                                            </form>
                                </div>
                                <% } else { %>
                                    <span class="text-muted">Tu cuenta</span>
                                    <% } %>
                        </td>
                    </tr>
                    <% }); %>
            </tbody>
        </table>
    </div>

    <style>
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge-validated {
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        .badge-pending {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
            border: 1px solid #f39c12;
        }

        .role-admin {
            background: rgba(231, 76, 60, 0.2);
            color: #c0392b;
            border: 1px solid #c0392b;
        }

        .role-profesor {
            background: rgba(52, 152, 219, 0.2);
            color: #2980b9;
            border: 1px solid #2980b9;
        }

        .role-alumno {
            background: rgba(155, 89, 182, 0.2);
            color: #8e44ad;
            border: 1px solid #8e44ad;
        }

        .btn-success-sm {
            padding: 6px 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-success-sm:hover {
            background: #229954;
            transform: translateY(-1px);
        }

        .btn-danger-sm {
            padding: 6px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-danger-sm:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .select-sm {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .actions {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: wrap;
        }

        .text-muted {
            color: #95a5a6;
            font-style: italic;
        }

        .assignment-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .current-assignment {
            font-size: 0.85rem;
            color: #2c3e50;
        }

        .assign-form {
            margin: 0;
        }

        .select-xs {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 0.8rem;
            width: 100%;
            max-width: 150px;
            background-color: #f8f9fa;
        }

        .select-xs:focus {
            outline: none;
            border-color: #667eea;
            background-color: white;
        }
    </style>

    <%- include('footer') %>