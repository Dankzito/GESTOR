<%- include('layout', { title: 'Calificaciones' }) %>
  <div class="card">
    <h2>Gestor de Calificaciones</h2>
    
    <% if (user.role === 'alumno') { %>
      <p style="color: #7f8c8d; margin-bottom: 20px;">
        Aquí puedes ver tus calificaciones.
      </p>
    <% } else if (user.role === 'profesor') { %>
      <% if (estudiantes && estudiantes.length > 0) { %>
        <form action="/calificaciones" method="post" class="inline-form">
          <select name="alumnoId" required>
            <option value="" disabled selected>Seleccionar Estudiante</option>
            <% estudiantes.forEach(e=> { %>
              <option value="<%= e.id %>">
                <%= e.nombre %>
              </option>
            <% }) %>
          </select>
          <input name="nota" placeholder="Nota" type="number" min="0" max="10" required />
          <input name="comentario" placeholder="Comentario" />
          <button class="btn">Guardar</button>
        </form>
      <% } else { %>
        <p style="color: #7f8c8d; margin-bottom: 20px;">
          No hay estudiantes disponibles para calificar. Asegúrate de tener materias asignadas con años correspondientes.
        </p>
      <% } %>
    <% } else if (user.role === 'admin') { %>
      <p style="color: #7f8c8d; margin-bottom: 20px;">
        Las calificaciones se crean desde el panel de administración o por profesores validados.
      </p>
    <% } %>

    <% if (calificaciones && calificaciones.length > 0) { %>
      <table class="tabla">
        <thead>
          <tr>
            <th>Estudiante</th>
            <th>Materia / Profesor</th>
            <th>Nota</th>
            <th>Comentario</th>
            <th>Fecha</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% calificaciones.forEach(c=> { %>
            <tr>
              <td>
                <%= c.estudiante_nombre || '—' %>
              </td>
              <td>
                <% if(c.materia) { %>
                  <%= c.materia %>
                  <% if(c.profesor_nombre) { %> (<%= c.profesor_nombre %>) <% } %>
                <% } else { %>
                  <%= c.profesor_nombre || '—' %>
                <% } %>
              </td>
              <td>
                <span class="grade-badge"><%= c.nota %></span>
              </td>
              <td>
                <%= c.comentario || '-' %>
              </td>
              <td>
                <%= new Date(c.fecha).toLocaleString('es-ES', { 
                  year: 'numeric', 
                  month: 'long', 
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                }) %>
              </td>
              <td>
                <% if (user.role==='profesor' || user.role==='admin' ) { %>
                  <form style="display:inline" method="post" action="/calificaciones/<%= c.id %>/edit">
                    <input name="nota" value="<%= c.nota %>" style="width:60px" type="number" min="0" max="10" />
                    <input name="comentario" value="<%= c.comentario || '' %>" />
                    <button class="link-btn">Editar</button>
                  </form>
                <% } %>
                <% if (user.role==='admin' ) { %>
                  <form style="display:inline" method="post" action="/calificaciones/<%= c.id %>/delete" onsubmit="return confirm('¿Eliminar esta calificación?');">
                    <button class="link-btn">Eliminar</button>
                  </form>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } else { %>
      <div style="text-align: center; padding: 40px; color: #7f8c8d;">
        <p style="font-size: 1.1rem;">No hay calificaciones registradas aún.</p>
      </div>
    <% } %>
  </div>

  <style>
    .grade-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.95rem;
      display: inline-block;
      min-width: 40px;
      text-align: center;
    }
  </style>
  <%- include('footer') %>